<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" href="/assets/favicon.ico">


    
    
    <title>AWS DMS를 활용하여 Oracle에서 MySQL로 DB 마이그레이션 하기 · 클라우드메이트 기술 블로그</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    <link rel="stylesheet" href="/style.main.min.629edc7f0383a79695b1d8c555e802fff749270aa5fee8f0b03e940c275110f5.css" />

    
    <link rel="stylesheet" href="/style.custom.min.46e5959d5dbf0c21baa1f31482fb76af9f442ea510c4f48e34ef01cfdc794cd7.css" />
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146594086-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta property="og:title" content="AWS DMS를 활용하여 Oracle에서 MySQL로 DB 마이그레이션 하기" />
<meta property="og:description" content="시작하기 전에 현대차, 카카오, KT, 대한항공 등 에서 촉발된 탈(脫) Oracle 프로젝트(escape from oracle)는 오픈소스 DB, 클라우드 DB 의 안정성이 높아지면서" />

<meta property="article:author" content="김정우"/>



<meta property="og:image" content="/2020/11/16/db_migration_from_oracle_to_mysql_in_aws_ec2/images/architecture.png" />
</head>
<body class=" post-template ">

    <div class="site-wrapper">

<header class="site-header"><div class="outer site-nav-main">
    <div class="inner"><nav class="site-nav">
    <div class="site-nav-left">
        
            <a class="site-nav-logo" href="https://cloudmt.co.kr"><img src="/assets/images/CMLOGO_WHITE.png" alt="클라우드메이트 기술 블로그" /></a>
        
        
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                <li class="nav-home" role="menuitem"><a href="/"><b>🏠Tech Home</b></a></li>
                
                <li class="nav-home" role="menuitem"><a href="/categories/hands-on">Hands On</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/categories/tech">Tech</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/categories/column">Column</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/categories/mate-story">Mate Story</a></li>
                
                
                <li class="nav-home" role="menuitem"><a href="https://cloudmt.co.kr">cloudmt.co.kr</a></li>
                
            </ul>
        </div>
        
    </div>
</nav></div>
</div></header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post ">

            <header class="post-full-header">
                
                    <section class="post-full-tags">
                    
                    
                        <a href="/categories/post"><b>Post</b></a>
                    
                    
                        <a href="/tags/db-migration" style="margin-left: 10px">#DB Migration</a>
                    
                        <a href="/tags/on-premise" style="margin-left: 10px">#On-premise</a>
                    
                        <a href="/tags/oracle" style="margin-left: 10px">#Oracle</a>
                    
                        <a href="/tags/mysql" style="margin-left: 10px">#MySQL</a>
                    
                        <a href="/tags/cloud" style="margin-left: 10px">#Cloud</a>
                    
                        <a href="/tags/amazon-web-services" style="margin-left: 10px">#Amazon Web Services</a>
                    
                        <a href="/tags/aws" style="margin-left: 10px">#AWS</a>
                    
                        <a href="/tags/ec2" style="margin-left: 10px">#EC2</a>
                    
                        <a href="/tags/dms" style="margin-left: 10px">#DMS</a>
                    
                        <a href="/tags/sct" style="margin-left: 10px">#SCT</a>
                    
                    </section>
                
                <h1 class="post-full-title">AWS DMS를 활용하여 Oracle에서 MySQL로 DB 마이그레이션 하기</h1>

                

                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        <ul class="author-list">
  <li class="author-list-item">
        <div class="author-card">
            <div class="author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></div>
            <div class="author-info">
                <div class="author-info">
                    <h2>김정우</h2>
                </div>
            </div>
        </div>
        <a href="/authors/jungwoo-kim/" class="static-avatar author-profile-image">
            
                <div class="author-profile"
                    style="background: url(/authors/jungwoo-kim/%ea%b9%80%ec%a0%95%ec%9a%b0.jpg) no-repeat center; 
                    background-size: cover; width: 30px; height: 30px; 
                    border-radius: 100%; margin-bottom: 10px;">
                </div>
            
        </a>
    </li>
  

</ul>

                        <section class="post-full-byline-meta">
                            
                                
                                <h4 class="author-name">김정우</h4>
                                
                            
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2020-1211-11">2020. 11. 16.</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 9 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            
            <figure class="post-full-image">
                <img src="images/architecture.png" alt="AWS DMS를 활용하여 Oracle에서 MySQL로 DB 마이그레이션 하기" />
            </figure>
            

            <section class="post-full-content">
                <div class="post-content">
                    <h2 id="시작하기-전에">시작하기 전에</h2>
<p>현대차, 카카오, KT, 대한항공 등 에서 촉발된 <code>탈(脫) Oracle</code> 프로젝트(<code>escape from oracle</code>)는 오픈소스 DB, 클라우드 DB 의 안정성이 높아지면서 국내 뿐만 아니라 해외에서 먼저 트렌드로 자리잡았으나, 그럼에도 불구하고 현존 RDBMS 중 성능 최강인 <del>(가격도 최강)</del> Oracle 을 100% 대체할 수 있는 RDBMS는 안타깝게도 아직까지는 없다고 생각합니다. (2020년말기준) 그렇기 때문에 Oracle에서 벗어나려면 Oracle에서만 지원하는 기능을 어떻게 타겟DB에서 대체 또는 구현할지 에 대한 깊은 고민이 필요합니다. <del>(굳은 신념도 필요합니다.)</del></p>
<p>이번 C고객사에서는 시범적으로 기존 온프레미스 Oracle 의 레플리카를 퍼블릭 클라우드 환경으로 마이그레이션 하여 향후에 있을 감사 등 에 대응할 수 있길 원하셨습니다. 미션 크리티컬한 서비스 DB 가 아니여서 다운타임에 대한 고려가 불필요했습니다. 빗발치는 OLTP 가 발생하지 않는 DB의 마이그레이션이라&hellip; 꿀냄새가 진동하네요.</p>
<p><img src="images/toon_w.png" alt="Close your eyes and hope for the best. AWS에서 제공하는 도구는 꽤나 강력합니다."></p>
<hr>
<h2 id="사전-검토">사전 검토</h2>
<ul>
<li>소스 DB 체크
<ol>
<li>버전: Oracle 11g Ent (Release 11.2.0.4.0) on TNS for Linux - 64bit</li>
<li>총용량(1TiB 가량)</li>
<li>오브젝트 현황 파악</li>
</ol>
</li>
<li>타겟 DB 체크
<ol>
<li>버전: MySQL 8.0.21 on Amazon Linux 2 - 64bit</li>
<li>EC2 인스턴스 유형: r5.4xlarge (vCPUs: 16, 메모리: 128GiB)</li>
</ol>
</li>
<li>AWS 콘솔에서 작업자 접속용 EC2 인스턴스 생성 (이하 <code>작업콘솔</code>)</li>
<li><code>작업콘솔</code> 에서 소스, 타겟 접속 가능하도록 가상 네트워크 구성 및 방화벽 설정</li>
<li>작업 절차 거버넌스
<ol>
<li>Schema Conversion Tool (이하 <code>SCT</code>) 로 스키마 이관</li>
<li>Database Migration Service (이하 <code>DMS</code>) 로 데이터 이관</li>
<li>미싱 스키마, 미싱 데이터 수동 점검</li>
</ol>
</li>
<li>Procedure, fucntion, sequence 는 마이그레이션 대상에서 제외</li>
<li>별도의 SSL 구성은 하지 않음</li>
</ul>
<hr>
<h2 id="마이그레이션-아키텍쳐">마이그레이션 아키텍쳐</h2>
<p><img src="images/architecture.png" alt="Migration Architecture"></p>
<blockquote>
<ol>
<li>작업콘솔의 SCT에서 소스의 스키마를 DDL 형태로 로드하여 타겟에 적용합니다.</li>
<li>AWS 콘솔에서 DMS 내에 필요한 리소스를 셋팅 합니다.<br>
<em><strong>(복제 인스턴스, 소스/타겟 엔드포인트 생성)</strong></em></li>
<li>DMS 내에 여러 마이그레이션 태스크를 소스 스키마 단위로 생성하고 일괄 실행합니다.</li>
<li>소스, 타겟에 직접 SQL을 실행하여 전체 오브젝트 현황을 비교하고 검증합니다.</li>
</ol>
</blockquote>
<p>자 이제 사전 검토했고 아키텍쳐 파악했으니, 실제로 시작해봅시다.</p>
<hr>
<h2 id="1-작업콘솔을-셋팅-합니다">1. <code>작업콘솔</code>을 셋팅 합니다.</h2>
<ol>
<li>
<p>AWS 콘솔에서 퍼블릭 IPv4 와 RDP port 를 확인하여 <code>작업콘솔</code>에 원격 접속 합니다. <br>
<img src="images/aws_01.png" alt="AWS console"></p>
</li>
<li>
<p><code>작업콘솔</code>에서 소스 검증을 위하여 SQL Developer 설치 후 소스DB 접속 테스트를 합니다.<br>
<img src="images/sqldeveloper.png" alt="SQL Developer 에서 소스 접속 성공"></p>
</li>
<li>
<p><code>작업콘솔</code>에서 타겟 검증을 위하여 WorkBench 설치 후 타겟DB 접속 테스트를 합니다.<br>
<img src="images/workbench.png" alt="WorkBench 에서 타겟 접속 성공"></p>
</li>
<li>
<p><code>작업콘솔</code>에서 스키마 이관을 위하여 SCT 설치 후 소스, 타겟 접속 테스트를 합니다. SCT &gt; New Project wizard IU 입니다. Source engine 의 기본값이 <code>Oracle</code>인 것이 흥미롭습니다.<br>
<img src="images/sct_01.png" alt="SCT > New Project wizard IU"></p>
</li>
</ol>
<hr>
<h2 id="2-타겟db-셋팅">2. 타겟DB 셋팅</h2>
<h3 id="1-buffer-pool">1. Buffer pool</h3>
<p>DMS가 타겟DB에 값을 쓸 때 버퍼캐쉬 크기가 처리 성능을 크게 좌우합니다. 디폴트값(128MB)에서 일시적으로 서버 메모리 한도 내에서 최대한으로 설정하도록 권장 드립니다. 금번 프로젝트의 경우 64GiB 로 설정하여 진행했습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- buffer pool size 확인 (GiB)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">@@</span>innodb_buffer_pool_size <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">1024</span>;
</code></pre></div><p>※ Innodb buffer pool size가 쓰기 성능에 얼만큼 영향이 큰지 테스트한 블로그 링크 참고 바랍니다.<br>
<a href="https://santander.co.kr/151">블로그 - innodb mysql/mariadb insert 속도 높이기</a></p>
<h3 id="2-timezone">2. Timezone</h3>
<p>EC2 에 MySQL 바이너리 설치한 초기 상태에서는 timezone 을 소스와 동일한 timezone 으로 설정해주어야 합니다. 먼저 소스 DB의 timezone을 확인합니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span>   DBTIMEZONE,
   SESSIONTIMEZONE
<span style="color:#66d9ef">FROM</span>  DUAL;
</code></pre></div><blockquote>
<table>
<thead>
<tr>
<th>DBTIMEZONE</th>
<th>SESSIONTIMEZONE</th>
</tr>
</thead>
<tbody>
<tr>
<td>+09:00</td>
<td>UTC</td>
</tr>
</tbody>
</table>
</blockquote>
<p><!-- raw HTML omitted -->소스DB의 timezone 은 UTC + 09:00 인 Korea Standard Time(KST) 인 것을 확인 했습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- 타겟DB timezone 중에 &#39;Seoul&#39;이 존재하는지 확인
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span>  B.NAME,A.TIME_ZONE_ID
<span style="color:#66d9ef">FROM</span>    MYSQL.TIME_ZONE A
        <span style="color:#66d9ef">INNER</span> <span style="color:#66d9ef">JOIN</span> MYSQL.TIME_ZONE_NAME B <span style="color:#66d9ef">ON</span> A.TIME_ZONE_ID <span style="color:#f92672">=</span> B.TIME_ZONE_ID
<span style="color:#66d9ef">WHERE</span>   B.NAME <span style="color:#66d9ef">LIKE</span> <span style="color:#e6db74">&#39;%Seoul&#39;</span>;
</code></pre></div><p><code>Asia/Seoul</code> timezone이 존재하지 않는다면 EC2 에서 다음과 같은 명령을 실행합니다.
아래 명령을 통하여 타겟DB의 표준시간대 테이블에 데이터를 삽입해줍니다.<br>
<a href="https://dev.mysql.com/doc/refman/8.0/en/mysql-tzinfo-to-sql.html">MySQL 8.0 참조 매뉴얼  /  &hellip;  /  mysql_tzinfo_to_sql — 시간대 테이블로드</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root -p mysql
</code></pre></div><p>타겟DB 설치경로 안에 <code>/etc/my.cnf</code> 또는 <code>/etc/my.cnf.d/</code> 경로 안에 <code>my.cnf</code> 파일 또는 <code>my.ini</code> 파일을 열어 안에 다음 내용을 추가해줍니다.</p>
<pre><code>[mysqld]
default-time-zone=Asia/Seoul
</code></pre><p>소스DB의 timezone에 맞춰 타겟DB 의 timezone 을 <code>Asia/Seoul</code> (KST) 로 변경해주어야 합니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SET</span> <span style="color:#66d9ef">GLOBAL</span> time_zone <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Asia/Seoul&#39;</span>;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- 변경된 timezone 확인
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SELECT</span> <span style="color:#f92672">@@</span>TIME_ZONE, <span style="color:#f92672">@@</span>system_time_zone, <span style="color:#f92672">@@</span><span style="color:#66d9ef">GLOBAL</span>.TIME_ZONE, <span style="color:#f92672">@@</span><span style="color:#66d9ef">SESSION</span>.TIME_ZONE;
</code></pre></div><blockquote>
<table>
<thead>
<tr>
<th>@@TIME_ZONE</th>
<th>@@system_time_zone</th>
<th>@@GLOBAL.TIME_ZONE</th>
<th>@@SESSION.TIME_ZONE</th>
</tr>
</thead>
<tbody>
<tr>
<td>+09:00</td>
<td>KST</td>
<td>+09:00</td>
<td>+09:00</td>
</tr>
</tbody>
</table>
</blockquote>
<p><!-- raw HTML omitted -->정상적으로 적용되어 있는 것 확인 완료요!</p>
<p>※ MySQL on RDS 는 AWS 콘솔에서 <code>Parameter Group</code> 생성 및 적용하여 비교적 간단하게 변경 가능합니다.</p>
<h3 id="3-charset">3. Charset</h3>
<p>소스DB의 charset을 확인하여 타겟DB에 적용해주도록 합니다. 데이터를 이관하기 전에 신중히 결정해야할 사항이며 이관 완료 이후에 charset, collation 변경 작업은 지옥문을 여는 경험이 될 수 있습니다. 일단 먼저 소스 DB의 charset을 확인합니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span>  NAME, VALUE$
<span style="color:#66d9ef">FROM</span>    SYS.PROPS$
<span style="color:#66d9ef">WHERE</span>   NAME <span style="color:#66d9ef">IN</span> (<span style="color:#e6db74">&#39;NLS_LANGUAGE&#39;</span>
    ,<span style="color:#e6db74">&#39;NLS_DATE_LANGUAGE&#39;</span>
    ,<span style="color:#e6db74">&#39;NLS_CHARACTERSET&#39;</span>
    ,<span style="color:#e6db74">&#39;NLS_NCHAR_CHARACTERSET&#39;</span>);

<span style="color:#66d9ef">SELECT</span>  <span style="color:#66d9ef">PARAMETER</span>, VALUE
<span style="color:#66d9ef">FROM</span>    NLS_DATABASE_PARAMETERS
<span style="color:#66d9ef">WHERE</span>   <span style="color:#66d9ef">PARAMETER</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;NLS_CHARACTERSET&#39;</span>;
</code></pre></div><p>resultset[0]</p>
<blockquote>
<table>
<thead>
<tr>
<th>NAME</th>
<th>VALUE$</th>
</tr>
</thead>
<tbody>
<tr>
<td>NLS_NCHAR_CHARACTERSET</td>
<td>AL16UTF16</td>
</tr>
<tr>
<td>NLS_LANGUAGE</td>
<td>AMERICAN</td>
</tr>
<tr>
<td>NLS_DATE_LANGUAGE</td>
<td>AMERICAN</td>
</tr>
<tr>
<td>NLS_CHARACTERSET</td>
<td><code>KO16KSC5601</code></td>
</tr>
</tbody>
</table>
</blockquote>
<p><!-- raw HTML omitted -->resultset[1]</p>
<blockquote>
<table>
<thead>
<tr>
<th>PARAMETER</th>
<th>VALUE</th>
</tr>
</thead>
<tbody>
<tr>
<td>NLS_CHARACTERSET</td>
<td><code>KO16KSC5601</code></td>
</tr>
</tbody>
</table>
</blockquote>
<p>NLS_CHARACTERSET 이 <code>KO16KSC5601</code>에 대응되는 charset 은 <code>EUCKR</code>, 또는 커버리지가 더 넓은 <code>UTF8</code>을 생각해볼 수 있습니다. charset <code>EUCKR</code> 에 대한 collation 은 <code>EUCKR_KOREAN_CI</code>, <code>EUCKR_BIN</code> 이 있는데 대소문자가 구별되는 이유로 <code>EUCKR_BIN</code> 이 적합합니다.</p>
<ul>
<li><code>EUCKR_BIN</code>: 한국어, 바이너리, <strong>대소문자 구분함</strong></li>
<li><code>EUCKR_KOREAN_CI</code>: 한국어, 대소문자 구분 안함</li>
</ul>
<p>Charset <code>EUCKR</code>, collation <code>EUCKR_BIN</code>을 결정했으니 이제 서버에 아래 명령을 실행해줍니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ vi /etc/mysql/my.cnf
</code></pre></div><p>파일 내용의 마지막에 다음 부분을 덧붙여준 후 :wq 로 저장 후 닫아줍니다. 그리고 서비스를 재시작하면 적용됩니다.</p>
<pre><code>[client]
default-character-set=euckr

[mysql]
default-character-set=euckr

[mysqld]
collation-server = euckr_bin
init-connect='SET NAMES euckr'
character-set-server = euckr
</code></pre><p>Charset, collation 도 설정 완료했습니다~</p>
<hr>
<h2 id="3-sct로-스키마를-이관해봅시다">3. <code>SCT</code>로 스키마를 이관해봅시다.</h2>
<p><img src="images/flow_sct.png" alt=" "></p>
<ol>
<li>
<p>소스에서 SCT로 이관할 스키마를 선택하고 <code>Next</code>를 클릭합니다. 선택한 스키마 내에 전체 오브젝트 개수에 비례하여 시간이 오래 걸릴 수 있습니다.<br>
<img src="images/sct_02.png" alt="SCT에서 소스 스키마 선택"></p>
</li>
<li>
<p>소스 스키마에 대한 로드 작업이 끝나면 여러가지 타겟의 종류 별로 몇개가 이관 가능한지, 몇개는 수동 조치를 취해야 하는지 전체 조사한 <code>Database migration assessment report</code>를 보여줍니다. pdf로도 다운로드 가능하며, 전체적으로 한번 훑어보고 <code>Next</code>를 클릭합니다.<br>
<em>(Procedure, funcion, sequence 는 migrating 대상이 아니므로 부담없이 <code>Next</code>클릭)</em><br>
<img src="images/sct_03.png" alt="보고서"></p>
</li>
<li>
<p>SCT 관점에서 타겟의 엔진이 MySQL 인 것이 의미가 있고, RDS 또는 EC2 중 어떤 것인지는 중요하지 않기 때문에 <code>Amazon RDS for MySQL</code>을 선택하고 타겟의 접속정보 입력 후 <code>Test connection</code>, 접속 성공하면 <code>Next</code>를 클릭합니다.<br>
<img src="images/sct_04.png" alt="타겟 접속"></p>
</li>
<li>
<p>소스(좌측)에서 DDL을 추출할 스키마와 개체유형을 선택하고 <code>Convert schema</code>를 클릭합니다. 타겟(우측)에서 선택 체크된 항목들에 대해서 DDL을 적용하려면 <code>Apply to database</code>를 클릭하면 타겟 DB에 실제로 DDL이 적용됩니다.<br>
<img src="images/sct_05.png" alt="소스 Convert schema 클릭, 타겟 Apply to database 클릭"></p>
</li>
<li>
<p>타겟 DB에 아래 SQL을 실행해서 정상적으로 스키마가 적용되어 있는지 확인합니다.</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">SELECT</span>	A.TABLE_SCHEMA, A.<span style="color:#66d9ef">TABLE_NAME</span>, A.TABLE_COLLATION, A.TABLE_COMMENT,
        I.INDEX_COUNT, T.TRIGGER_COUNT
<span style="color:#66d9ef">FROM</span>	INFORMATION_SCHEMA.TABLES A
	    <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> <span style="color:#66d9ef">LATERAL</span> ( <span style="color:#75715e">-- like OUTER APPLY
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">SELECT</span>	<span style="color:#66d9ef">COUNT</span>(<span style="color:#66d9ef">DISTINCT</span> I.INDEX_NAME) <span style="color:#66d9ef">AS</span> INDEX_COUNT
		<span style="color:#66d9ef">FROM</span>	INFORMATION_SCHEMA.<span style="color:#66d9ef">STATISTICS</span> I
        <span style="color:#66d9ef">WHERE</span>	I.TABLE_SCHEMA <span style="color:#f92672">=</span> A.TABLE_SCHEMA
        <span style="color:#66d9ef">AND</span>	I.<span style="color:#66d9ef">TABLE_NAME</span> <span style="color:#f92672">=</span> A.<span style="color:#66d9ef">TABLE_NAME</span>
        <span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">1</span>
        ) I <span style="color:#66d9ef">ON</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">LEFT</span> <span style="color:#66d9ef">JOIN</span> <span style="color:#66d9ef">LATERAL</span> (
        <span style="color:#66d9ef">SELECT</span>	<span style="color:#66d9ef">COUNT</span>(<span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">AS</span> TRIGGER_COUNT
	    <span style="color:#66d9ef">FROM</span>	INFORMATION_SCHEMA.TRIGGERS T
        <span style="color:#66d9ef">WHERE</span>	T.<span style="color:#66d9ef">TRIGGER_SCHEMA</span> <span style="color:#f92672">=</span> A.TABLE_SCHEMA
        <span style="color:#66d9ef">AND</span>	T.EVENT_OBJECT_TABLE <span style="color:#f92672">=</span> A.<span style="color:#66d9ef">TABLE_NAME</span>
        <span style="color:#66d9ef">LIMIT</span> <span style="color:#ae81ff">1</span>
        ) T <span style="color:#66d9ef">ON</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">WHERE</span>	A.TABLE_SCHEMA <span style="color:#66d9ef">LIKE</span> <span style="color:#e6db74">&#39;%&#39;</span>;
</code></pre></div><p><img src="images/wb_resultset.png" alt="타겟 DB에서 테이블 적용 확인"></p>
<p>※ 타겟DB가 MySQL 인 경우 테이블과 컬럼의 <code>comment</code>가 SCT로 이관되지 않음을 확인했습니다. 금번 프로젝트 진행하면서 AWS 케이스 오픈을 통하여 정식 요청하였으며, 추후 픽스될 것으로 보입니다.</p>
<p>SCT에 대한 상세한 가이드는 <a href="https://docs.aws.amazon.com/ko_kr/SchemaConversionTool/latest/userguide/CHAP_Welcome.html">AWS Schema Conversion Tool User Guide</a> 를 참고 바랍니다.</p>
<p>만약 SCT로 trigger 까지 이관시켰다면 DMS 태스크 실행 시 trigger로 인해 오류가 떨어지고 태스크가 멈출 수 있으므로 trigger 를 백업받아놓고 모두 제거하는 것을 추천드립니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#75715e">-- 트리거 리스트 출력
</span><span style="color:#75715e"></span><span style="color:#66d9ef">SHOW</span> TRIGGERS;

<span style="color:#75715e">-- SCT 가 이관해준 트리거 소스는 메모장에 백업해놓고 모두 제거
</span><span style="color:#75715e"></span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TRIGGER</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">SCHEMA_NAME</span><span style="color:#f92672">&gt;</span>.<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">TABLE_NAME</span><span style="color:#f92672">&gt;</span>.<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">TRIGGER_NAME</span><span style="color:#f92672">&gt;</span>;
</code></pre></div><p>다시 한번 강조하지만 DMS로 데이터를 들이부은 이후에는 charset, collation 을 변경하는 데에 굉장히 긴 시간이 소요될 수 있습니다. 그래서 SCT 작업 끝나고 DMS 작업을 시작하기 이전에 아래 쿼리를 다시 실행해주면 세상 시원하겠습니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">DATABASE</span> <span style="color:#f92672">&lt;</span>database_name<span style="color:#f92672">&gt;</span> CHARACTER <span style="color:#66d9ef">SET</span> <span style="color:#f92672">=</span> EUCKR <span style="color:#66d9ef">COLLATE</span> <span style="color:#f92672">=</span> EUCKR_BIN;
<span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">&lt;</span><span style="color:#66d9ef">table_name</span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">CONVERT</span> <span style="color:#66d9ef">TO</span> CHARACTER <span style="color:#66d9ef">SET</span> EUCKR <span style="color:#66d9ef">COLLATE</span> EUCKR_BIN;
</code></pre></div><p><img src="images/doubleaction.png" alt="세상 시원"></p>
<hr>
<h2 id="4-dms로-데이터를-이관해봅시다">4. <code>DMS</code>로 데이터를 이관해봅시다.</h2>
<p><img src="images/flow_dms.png" alt=" ">
이제 본격적으로 <code>DMS</code>로 데이터를 넘겨볼껀데요. 그전에 복제 인스턴스, 엔드포인트, 마이그레이션 태스크를 생성해야 합니다.</p>
<p>먼저, 복제 인스턴스는 아래 사양으로 생성했습니다.</p>
<ul>
<li>클래스: dms.c4.4xlarge<br>
<del><em>(처음에는 c4.large였다가 너무 느려 속 터져서 업그레이드)</em></del></li>
<li>vCPUs: 8</li>
<li>메모리: 30GiB</li>
<li>전용EBS 대역폭: 2,000Mbps</li>
<li>할당 스토리지: 1000GiB</li>
</ul>
<p><img src="images/dms_01.png" alt="DMS 복제 인스턴스 생성 완료"></p>
<p>엔드포인트는 유형에 따라 <code>소스</code> 1개, <code>대상</code> 2개로 생성했습니다. 소스DB, 타겟DB 의 접속정보를 각각 알맞게 넣어주고 <code>테스트 실행</code>을 해봅니다.</p>
<p><img src="images/dms_02.png" alt="DMS 엔드포인트 생성 완료"></p>
<p>마이그레이션 태스크는 아래 캡처대로 순서대로 값을 입력합니다.</p>
<ul>
<li>태스크 식별자: 식별할 수 있는 이름</li>
<li>복제 인스턴스: 복제 인스턴스 선택</li>
<li>소스 엔드포인트: 소스DB 엔드포인트 선택</li>
<li>대상 엔드포인트: 타겟DB 엔드포인트 선택</li>
<li>마이그레이션 유형: <code>기존 데이터 마이그레이션</code> 선택<br>
<em>(기존 데이터를 일회성으로 마이그레이션할 것이기 때문에)</em></li>
<li>태스크 설정 편집모드: <code>마법사</code></li>
<li>대상 테이블 준비 모드: 아무 작업 안 함<br>
※ <code>대상에서 테이블 삭제</code> 는 DDL(drop &amp; create)을 실행하기 때문에 charset, collation, trigger 등이 원래대로 생성될 수 있음</li>
<li>복제에 LOB 열 포함: <code>전제 LOB 모드</code></li>
<li>LOB 청크 크기: 64</li>
<li>검증 활성화: Y</li>
<li>CloudWatch 로그 활성화: Y
※ 그외 CloudWatch 관련 설정들은 모두 <code>기본값</code></li>
<li>테이블 매핑 편집모드: <code>마법사</code></li>
<li>선택 규칙 &gt; <code>새 선택 규칙 추가</code> &gt; 스키마 입력 &gt; 테이블 이름 (필요에 따라 입력, % 는 전체 테이블)</li>
<li>마이그레이션 전 평가: N</li>
<li>마이그레이션 태스크 시작 구성: <code>나중에 수동으로</code></li>
<li>태그: (필요한 경우에 입력, 많이 입력할수록 추후에 찾기 용이함)</li>
<li><code>태스크 생성</code> 클릭</li>
</ul>
<p><img src="images/dms_03.png" alt="DMS 마이그레이션 태스크 등록 과정 (1)">
<img src="images/dms_04.png" alt="DMS 마이그레이션 태스크 등록 과정 (2)">
<img src="images/dms_05.png" alt="DMS 마이그레이션 태스크 등록 과정 (3)"></p>
<p>마이그레이션 해야할 스키마 갯수, 테이블 갯수에 따라 상황이 다르겠지만, 금번 프로젝트에서는 스키마 이름 단위로 태스크를 생성하여 마이그레이션을 진행했습니다. (테이블 이름은 % 로 그냥 둔채로)</p>
<p>스키마 갯수 대로 태스크를 생성해놓은 다음 태스크들을 일괄로 <code>시작</code>을 눌러줍니다.</p>
<p><img src="images/dms_06.png" alt="DMS 마이그레이션 태스크 시작"></p>
<p>상태 값에는 다음 값들이 올 수 있으며, 아무 오류 없이 완료 되면 <code>로드 완료</code> 로 바뀌게 됩니다. 이제 우리가 해야할 것은 오로지, <code>Close your eyes and hope for the best</code> 말고는 없습니다.</p>
<hr>
<h2 id="5-마이그레이션-검증">5. 마이그레이션 검증</h2>
<p>데이터까지 마이그레이션이 완료된 후에는 소스, 타겟의 difference 가 존재하는지 검증해봐야 하며 검증 절차는 아래와 같이 구성하였습니다.</p>
<ol>
<li>소스, 타겟의 테이블(뷰 포함) 갯수 비교</li>
<li>소스, 타겟의 테이블 당 row count 비교</li>
<li>소스, 타겟의 Index 갯수 비교</li>
<li>소스, 타겟의 Constraint 갯수 비교</li>
</ol>
<p>위 절차들의 검증이 모두 끝나고 나면 비로소 DB 마이그레이션 작업이 완료됐다고 볼 수 있습니다. 아래 이미지는 Google sheet로 기록해놓았던 이관진행 문서입니다.</p>
<p><img src="images/validation.png" alt="마이그레이션 진행 문서"></p>
<hr>
<h2 id="작업을-마치며">작업을 마치며</h2>
<p>그동안 Youtube로만 접했던 AWS의 <code>DMS</code>, <code>SCT</code>를 직접 사용해보니 아주 약간의 버그성 동작과 모호한 UI 로 인해 작업 초반에는 생산성이 떨어졌던 것이 사실이나, 소스/타겟에서 지원하는 DB engine 종류가 매우 다양하며 특히 데이터를 일괄로 퍼서 넘기는 속도 등 성능이 뛰어나다고 봅니다. <del>(육아와 DB이관은 캐시템 으로 해결하세요.)</del></p>
<p>향후에 실 서비스 상태의 DB를 마이그레이션 하게 되는 경우 추가로 고려해야 할 것들을 대략 정리해봤습니다.</p>
<ol>
<li>다운타임 최소화</li>
<li>지속적인 변경 사항 복제 시 지연시간 최소화</li>
<li>실패 시 roll-back 방안</li>
</ol>
<p>전통적인 DB 마이그레이션 작업은 일부 DBA, 일부 DB개발자 들만의 야간 작업으로 많이 치부되어오곤 했었습니다. 마이그레이션 진행 시 철야는 물론이었고, 스크립트 수작업하는 경우도 부지기수 였고, 경험 많은 DBA가 없으면 심각한 예외상황에 직면했을 경우 롤백하는 경우도 많았었지요.</p>
<p>AWS DMS의 경우 AWS콘솔에서 누구나 쉽게 이해하고 사용할 수 있도록 구성되어 있어서, 이제 앞으로의 DB 마이그레이션은 기성 DBA 들만의 작업이 아닐 수 있겠다는 생각이 들었네요.</p>

                </div>
            </section>

        </article>

    </div>
</main>
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">

    <article class="read-next-card">
        <header class="read-next-card-header">
            <h3><span>More in</span> <a href="/categories/post">Post</a></h3>
        </header>
        <div class="read-next-card-content">
            <ul>
                
                <li>
                    <h4><a href="/2021/02/17/spot_by_netapp_%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/">Spot By NetApp 시작하기</a></h4>
                    <div class="read-next-card-meta">
                            <p><time datetime="2021-122-02">2021. 02. 17.</time> 
                                
                            </p>
                    </div>
                </li>
                
                <li>
                    <h4><a href="/2021/02/16/devtest-%ED%86%B5%ED%95%9C-devops-%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0/">DevTest 통한 DevOps 구성하기</a></h4>
                    <div class="read-next-card-meta">
                            <p><time datetime="2021-122-02">2021. 02. 16.</time> 
                                
                            </p>
                    </div>
                </li>
                
                <li>
                    <h4><a href="/2021/02/16/%EC%A0%81%EC%A0%88%ED%95%9Cazure%EC%9A%B4%EC%98%81%EC%9C%BC%EB%A1%9C%EB%B9%84%EC%9A%A9%EC%9D%84%EC%B5%9C%EC%A0%81%ED%99%94%ED%95%98%EC%8B%9C%EB%A9%B4%EB%90%A9%EB%8B%88%EB%8B%A4/">적절한 Azure 운영으로 비용을 최적화하시면 됩니다.</a></h4>
                    <div class="read-next-card-meta">
                            <p><time datetime="2021-122-02">2021. 02. 16.</time> 
                                
                            </p>
                    </div>
                </li>
                
            </ul>
        </div>
    </article>
<article class="post-card post


 ">

        
            <a class="post-card-image-link" href="/2020/11/15/quick-aspnet-dev-azmanaged-deploy-part1/">
                <img class="post-card-image"src="/2020/11/15/quick-aspnet-dev-azmanaged-deploy-part1/images/apidoc.png" alt="ASP.NET앱 개발과 Azure 관리형 서비스로 배포하기 - 1. 코드 자동 생성을 통한 개발시간 단축"/>
            </a>
        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="/2020/11/15/quick-aspnet-dev-azmanaged-deploy-part1/">
    
                <header class="post-card-header">
                    
                        
                        <div class="post-card-primary-tag">Tech</div>
                    

                    <h2 class="post-card-title">ASP.NET앱 개발과 Azure 관리형 서비스로 배포하기 - 1. 코드 자동 생성을 통한 개발시간 단축</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p>목차 이 글은 내용이 길어서 둘로 나눠져 있다. 아래 목차를 참고하여 읽는것을 권장한다. 1부. 코드 자동 생성을 통한 개발시간 단축 👈 서론 그냥 데이터만 간단히 쌓아주</p>
                </section>
    
            </a>

            
                
                
                <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"><b>한영빈</b>님의 글 모두 보기</div>
                            <a href="/authors/youngbin-han/" class="static-avatar author-profile-image">
                            
                                <div class="author-profile"
                                    style="background: url(/authors/youngbin-han/%ed%95%9c%ec%98%81%eb%b9%88.jpg) no-repeat center; 
                                    background-size: cover; width: 30px; height: 30px; 
                                    border-radius: 100%; margin-bottom: 10px;">
                                </div>
                            
                            </a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span>한영빈</span>
                        <span class="post-card-byline-date"><time datetime="2020-1211-11">2020. 11. 15.</time>
                            <span class="bull">&bull;</span> 12 min read</span>
                    </div>
                </footer>
                
            
        </div>

</article>

            <article class="post-card post


 ">

        
            <a class="post-card-image-link" href="/2020/12/10/aws-iam%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-private-%EB%A7%9D-ec2-%EC%A0%91%EA%B7%BC%EA%B3%BC-%EB%A1%9C%EA%B9%85%ED%95%98%EA%B8%B0/">
                <img class="post-card-image"src="/2020/12/10/aws-iam%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-private-%EB%A7%9D-ec2-%EC%A0%91%EA%B7%BC%EA%B3%BC-%EB%A1%9C%EA%B9%85%ED%95%98%EA%B8%B0/images/image1.png" alt="AWS IAM을 사용한 Private 망 EC2 인스턴스 접근과 로깅"/>
            </a>
        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="/2020/12/10/aws-iam%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-private-%EB%A7%9D-ec2-%EC%A0%91%EA%B7%BC%EA%B3%BC-%EB%A1%9C%EA%B9%85%ED%95%98%EA%B8%B0/">
    
                <header class="post-card-header">
                    
                        
                        <div class="post-card-primary-tag">Post</div>
                    

                    <h2 class="post-card-title">AWS IAM을 사용한 Private 망 EC2 인스턴스 접근과 로깅</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p>소개 On-premise 에서든 Cloud 환경에서이든 서비스를 위한 운영환경은 외부 인터넷으로부터 분리되어 있어야하며 외부와의 접촉점이 있더라도 최소화해아하는 점은 동일합니다. 그</p>
                </section>
    
            </a>

            
                
                
                <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"><b>김성진</b>님의 글 모두 보기</div>
                            <a href="/authors/seongjin-kim/" class="static-avatar author-profile-image">
                            
                                <div class="author-profile"
                                    style="background: url(/authors/seongjin-kim/%ea%b9%80%ec%84%b1%ec%a7%84.jpg) no-repeat center; 
                                    background-size: cover; width: 30px; height: 30px; 
                                    border-radius: 100%; margin-bottom: 10px;">
                                </div>
                            
                            </a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span>김성진</span>
                        <span class="post-card-byline-date"><time datetime="2020-1212-12">2020. 12. 10.</time>
                            <span class="bull">&bull;</span> 3 min read</span>
                    </div>
                </footer>
                
            
        </div>

</article>
        </div>
    </div>
</aside>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="/">클라우드메이트 기술 블로그</a> &copy; 2020</section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    <a href="https://fb.me/cloudmatekr" target="_blank" rel="noopener">Facebook</a>
                    
                    <a href="https://github.com/mate365" target="_blank" rel="noopener">Github</a>
                    <a href="https://jonathanjanssens.com" target="_blank" rel="noopener" style="opacity: 0.5;">Hugo Casper3 by Jonathan Janssens</a>
                </nav>
            </div>
        </footer>

    </div>

</body>
</html>