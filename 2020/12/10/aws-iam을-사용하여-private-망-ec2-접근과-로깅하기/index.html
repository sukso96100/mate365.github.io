<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <link rel="icon" href="/assets/favicon.ico">


    
    
    <title>AWS IAM을 사용한 Private 망 EC2 인스턴스 접근과 로깅 · 클라우드메이트 기술 블로그</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    <link rel="stylesheet" href="/style.main.min.629edc7f0383a79695b1d8c555e802fff749270aa5fee8f0b03e940c275110f5.css" />

    
    <link rel="stylesheet" href="/style.custom.min.46e5959d5dbf0c21baa1f31482fb76af9f442ea510c4f48e34ef01cfdc794cd7.css" />
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146594086-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>
<meta property="og:title" content="AWS IAM을 사용한 Private 망 EC2 인스턴스 접근과 로깅" />
<meta property="og:description" content="소개 On-premise 에서든 Cloud 환경에서이든 서비스를 위한 운영환경은 외부 인터넷으로부터 분리되어 있어야하며 외부와의 접촉점이 있더라도 최소화해아하는 점은 동일합니다. 그" />

<meta property="article:author" content="김성진"/>



<meta property="og:image" content="/2020/12/10/aws-iam%EC%9D%84-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-private-%EB%A7%9D-ec2-%EC%A0%91%EA%B7%BC%EA%B3%BC-%EB%A1%9C%EA%B9%85%ED%95%98%EA%B8%B0/images/image1.png" />
</head>
<body class=" post-template ">

    <div class="site-wrapper">

<header class="site-header"><div class="outer site-nav-main">
    <div class="inner"><nav class="site-nav">
    <div class="site-nav-left">
        
            <a class="site-nav-logo" target="_blank" href="https://cloudmt.co.kr"><img src="/assets/images/CMLOGO_WHITE.png" alt="클라우드메이트 기술 블로그" /></a>
        
        
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                <li class="nav-home" role="menuitem"><a href="/"><b>🏠Tech Home</b></a></li>
                
                <li class="nav-home" role="menuitem"><a href="/categories/hands-on">Hands On</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/categories/tech">Tech</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/categories/column">Column</a></li>
                
                <li class="nav-home" role="menuitem"><a href="/categories/mate-story">Mate Story</a></li>
                
                
                <li class="nav-home" role="menuitem"><a href="https://cloudmt.co.kr">cloudmt.co.kr</a></li>
                
            </ul>
        </div>
        
    </div>
</nav></div>
</div></header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post ">

            <header class="post-full-header">
                
                    <section class="post-full-tags">
                    
                    
                        <a href="/categories/post"><b>Post</b></a>
                    
                    
                        <a href="/tags/aws" style="margin-left: 10px">#AWS</a>
                    
                        <a href="/tags/iam" style="margin-left: 10px">#IAM</a>
                    
                        <a href="/tags/session-manager" style="margin-left: 10px">#Session Manager</a>
                    
                        <a href="/tags/systems-manager" style="margin-left: 10px">#Systems Manager</a>
                    
                        <a href="/tags/ec2" style="margin-left: 10px">#EC2]</a>
                    
                    </section>
                
                <h1 class="post-full-title">AWS IAM을 사용한 Private 망 EC2 인스턴스 접근과 로깅</h1>

                

                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        <ul class="author-list">
  <li class="author-list-item">
        <div class="author-card">
            <div class="author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></div>
            <div class="author-info">
                <div class="author-info">
                    <h2>김성진</h2>
                </div>
            </div>
        </div>
        <a href="/authors/seongjin-kim/" class="static-avatar author-profile-image">
            
                <div class="author-profile"
                    style="background: url(/authors/seongjin-kim/%ea%b9%80%ec%84%b1%ec%a7%84.jpg) no-repeat center; 
                    background-size: cover; width: 30px; height: 30px; 
                    border-radius: 100%; margin-bottom: 10px;">
                </div>
            
        </a>
    </li>
  

</ul>

                        <section class="post-full-byline-meta">
                            
                                
                                <h4 class="author-name">김성진</h4>
                                
                            
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2020-1212-12">2020. 12. 10.</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 3 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            
            <figure class="post-full-image">
                <img src="images/image1.png" alt="AWS IAM을 사용한 Private 망 EC2 인스턴스 접근과 로깅" />
            </figure>
            

            <section class="post-full-content">
                <div class="post-content">
                    <ol>
<li>
<p>소개<br>
On-premise 에서든 Cloud 환경에서이든 서비스를 위한 운영환경은 외부 인터넷으로부터 분리되어 있어야하며 외부와의 접촉점이 있더라도 최소화해아하는 점은 동일합니다.<br>
그래서 두 환경모두 내부 운영 서버접근을 위해서 별도의 Bastion Host나 VPN등을 사용해 인증된 사용자만 접근가능하도록 구성합니다.<br>
AWS Systems Manager에서는 Private 망에 위치한 인스턴스 접근을 위해 위와 같은 별도 장치나 망구성을 변경하지 않고 IAM을 사용할 수 있습니다.
Systems Manager의 Session Manger를 이용하면 인스턴스 접근 뿐만 아니라 인스턴스에서 해당 사용자의 활동 로깅까지 할 수 있습니다.
지금 부터 이런 좋은 기능을 사용할 수 있게 환경을 구성해보겠습니다.</p>
</li>
<li>
<p>EC2 Policy 설정<br>
<img src="images/image1.png" alt=""><br>
<img src="images/image2.png" alt=""></p>
<p>JSON 편집기 창에 아래와 같은 Policy 정보를 입력합니다.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;Version&#34;</span>: <span style="color:#e6db74">&#34;2012-10-17&#34;</span>,
    <span style="color:#f92672">&#34;Statement&#34;</span>: [
        {
            <span style="color:#f92672">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
            <span style="color:#f92672">&#34;Action&#34;</span>: <span style="color:#e6db74">&#34;s3:GetObject&#34;</span>,
            <span style="color:#f92672">&#34;Resource&#34;</span>: [
                <span style="color:#e6db74">&#34;arn:aws:s3:::aws-ssm-us-east-2/*&#34;</span>,
                <span style="color:#e6db74">&#34;arn:aws:s3:::aws-windows-downloads-us-east-2/*&#34;</span>,
                <span style="color:#e6db74">&#34;arn:aws:s3:::amazon-ssm-us-east-2/*&#34;</span>,
                <span style="color:#e6db74">&#34;arn:aws:s3:::amazon-ssm-packages-us-east-2/*&#34;</span>,
                <span style="color:#e6db74">&#34;arn:aws:s3:::us-east-2-birdwatcher-prod/*&#34;</span>,
                <span style="color:#e6db74">&#34;arn:aws:s3:::aws-ssm-distributor-file-us-east-2/*&#34;</span>,
                <span style="color:#e6db74">&#34;arn:aws:s3:::patch-baseline-snapshot-us-east-2/*&#34;</span>
            ]
        },
        {
            <span style="color:#f92672">&#34;Effect&#34;</span>: <span style="color:#e6db74">&#34;Allow&#34;</span>,
            <span style="color:#f92672">&#34;Action&#34;</span>: [
                <span style="color:#e6db74">&#34;s3:GetObject&#34;</span>,
                <span style="color:#e6db74">&#34;s3:PutObject&#34;</span>,
                <span style="color:#e6db74">&#34;s3:PutObjectAcl&#34;</span>,
                <span style="color:#e6db74">&#34;s3:GetEncryptionConfiguration&#34;</span>
            ],
            <span style="color:#f92672">&#34;Resource&#34;</span>: [
                <span style="color:#e6db74">&#34;arn:aws:s3:::ssm-test-logs/*&#34;</span>,
                <span style="color:#e6db74">&#34;arn:aws:s3:::ssm-test-logs &#34;</span>
            ]
        }
    ]
}
</code></pre></div><p>붉은 색 부분에는 사용하고 있는 리전 및 SSM 로그를 저장할 S3 버킷을 적습니다.<br>
Review Policy를 선택하여 적절한 Name을 입력하고 Create policy로 정책을 생성합니다.</p>
</li>
<li>
<p>EC2 Role 설정<br>
다음은 EC2에 적용할 Role을 설정합니다.<br>
IAM &gt; Role &gt; Create role에서 EC2를 선택합니다.<br>
<img src="images/image3.png" alt=""><br>
<img src="images/image4.png" alt=""><br>
SSM을 사용하기 위한 기본 Policy를 선택<br>
<img src="images/image5.png" alt=""><br>
이전에 작성한 Policy를 선택<br>
<img src="images/image6.png" alt=""><br>
다음으로 넘어가 Tag 및 적절한 Role의 이름을 부여하여 Create role을 선택하여 Role을 생성합니다</p>
</li>
<li>
<p>VPC 앤드포인트 설정<br>
다음은 EC2가 Private한 환경에서도 AWS 서비스를 사용할 수 있도록 앤드포인트를 생성합니다.<br>
VPC &gt; Endpoint에서 Create Endpoint를 선택합니다.<br>
<img src="images/image7.png" alt=""><br>
Service Name을 검색합니다.<br>
(*ssm, ssmmessages, ec2messages, s3 총 4개를 하나씩 생성해야합니다.)<br>
<img src="images/image8.png" alt=""><br>
앤드포인트 및 EC2 에 사용할 SG을 선택합니다.
<img src="images/image9.png" alt=""><br>
위 과정을 반복하여 아래와 같이 총 4개의 앤드포인트를 생성합니다.
<img src="images/image10.png" alt=""><br>
라우팅 테이블 확인<br>
<img src="images/image11.png" alt=""><br>
IGW 및 NAT가 없으므로 해당 라우팅 테이블이 속한 서브넷에서는 외부인터넷망에 접근이 불가능한 것을 확인할 수 있습니다.</p>
</li>
<li>
<p>EC2 생성<br>
EC2 &gt; Launch Instance를 선택합니다.<br>
<img src="images/image12.png" alt=""><br>
<img src="images/image13.png" alt=""><br>
적절한 인스턴스 타입을 선택 후 Configure Instance에서 이전에 설정한 VPC 및 IAM Role을 선택하여 설정합니다.<br>
(기존 사용중인 인스턴스에 적용할 경우 해당 인스턴스의 IAM Role만
변경하면 됩니다.<br>
* Role 변경 시 기존 사용중인 Role의 정책에 의해 서비스에 영향이 있을 수
있으니 주의하세요.)<br>
<img src="images/image14.png" alt=""><br>
이후 적절한 스토리지 및 Tag를 추가하신 후 Configure Security Group에서 이전에 설정한 SG를 적용합니다.<br>
<img src="images/image15.png" alt=""></p>
</li>
<li>
<p>Security Group 설정<br>
SG를 아래와 같이 같은 SG를 가진 인터페이스간에는 통신이 가능하도록 같은 SG를 추가하고 HTTPS 정책을 VPC 내부의 CIDR을 적용하여 통신이 가능하도록 합니다.
<img src="images/image16.png" alt=""></p>
</li>
<li>
<p>System Manager<br>
System Manager &gt; Managed Instances에서 생성한 EC2 인스턴스가 확인되기를 기다립니다.<br>
<img src="images/image17.png" alt=""><br>
인스턴스가 확인이 된다면 Session Manager에서 Preferences에서 로깅을 설정합니다.<br>
<img src="images/image18.png" alt=""><br>
<img src="images/image19.png" alt=""><br>
*CloudWatch 로깅설정이 필요한 경우 CloudWatch logs를 체크합니다.<br>
*로그 또는 세션 데이터에 대한 암호화가 필요한 경우는 KMS 설정 및 S3 버킷 암호화를 참고하시기 바랍니다.</p>
</li>
<li>
<p>Session 시작하여 쉘 사용<br>
<img src="images/image20.png" alt=""><br>
<img src="images/image21.png" alt=""><br>
작업이 완료된 후 Session을 Terminate합니다.<br>
<img src="images/image22.png" alt=""><br>
Session history에서 S3에 저장된 log를 확인할 수 있습니다.<br>
<img src="images/image23.png" alt=""><br>
S3에서 log 파일을 다운로드 받습니다.<br>
<img src="images/image24.png" alt=""><br>
Log를 확인합니다.<br>
<img src="images/image25.png" alt=""><br>
감사합니다.</p>
</li>
</ol>

                </div>
            </section>

        </article>

    </div>
</main>
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">

    <article class="read-next-card">
        <header class="read-next-card-header">
            <h3><span>More in</span> <a href="/categories/post">Post</a></h3>
        </header>
        <div class="read-next-card-content">
            <ul>
                
                <li>
                    <h4><a href="/2021/02/17/spot_by_netapp_%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/">Spot By NetApp 시작하기</a></h4>
                    <div class="read-next-card-meta">
                            <p><time datetime="2021-122-02">2021. 02. 17.</time> 
                                
                            </p>
                    </div>
                </li>
                
                <li>
                    <h4><a href="/2021/02/16/devtest-%ED%86%B5%ED%95%9C-devops-%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0/">DevTest 통한 DevOps 구성하기</a></h4>
                    <div class="read-next-card-meta">
                            <p><time datetime="2021-122-02">2021. 02. 16.</time> 
                                
                            </p>
                    </div>
                </li>
                
                <li>
                    <h4><a href="/2021/02/16/%EC%A0%81%EC%A0%88%ED%95%9Cazure%EC%9A%B4%EC%98%81%EC%9C%BC%EB%A1%9C%EB%B9%84%EC%9A%A9%EC%9D%84%EC%B5%9C%EC%A0%81%ED%99%94%ED%95%98%EC%8B%9C%EB%A9%B4%EB%90%A9%EB%8B%88%EB%8B%A4/">적절한 Azure 운영으로 비용을 최적화하시면 됩니다.</a></h4>
                    <div class="read-next-card-meta">
                            <p><time datetime="2021-122-02">2021. 02. 16.</time> 
                                
                            </p>
                    </div>
                </li>
                
            </ul>
        </div>
    </article>
<article class="post-card post


 ">

        
            <a class="post-card-image-link" href="/2020/11/16/db_migration_from_oracle_to_mysql_in_aws_ec2/">
                <img class="post-card-image"src="/2020/11/16/db_migration_from_oracle_to_mysql_in_aws_ec2/images/architecture.png" alt="AWS DMS를 활용하여 Oracle에서 MySQL로 DB 마이그레이션 하기"/>
            </a>
        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="/2020/11/16/db_migration_from_oracle_to_mysql_in_aws_ec2/">
    
                <header class="post-card-header">
                    
                        
                        <div class="post-card-primary-tag">Post</div>
                    

                    <h2 class="post-card-title">AWS DMS를 활용하여 Oracle에서 MySQL로 DB 마이그레이션 하기</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p>시작하기 전에 현대차, 카카오, KT, 대한항공 등 에서 촉발된 탈(脫) Oracle 프로젝트(escape from oracle)는 오픈소스 DB, 클라우드 DB 의 안정성이 높아지면서</p>
                </section>
    
            </a>

            
                
                
                <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"><b>김정우</b>님의 글 모두 보기</div>
                            <a href="/authors/jungwoo-kim/" class="static-avatar author-profile-image">
                            
                                <div class="author-profile"
                                    style="background: url(/authors/jungwoo-kim/%ea%b9%80%ec%a0%95%ec%9a%b0.jpg) no-repeat center; 
                                    background-size: cover; width: 30px; height: 30px; 
                                    border-radius: 100%; margin-bottom: 10px;">
                                </div>
                            
                            </a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span>김정우</span>
                        <span class="post-card-byline-date"><time datetime="2020-1211-11">2020. 11. 16.</time>
                            <span class="bull">&bull;</span> 9 min read</span>
                    </div>
                </footer>
                
            
        </div>

</article>

            <article class="post-card post


 ">

        
            <a class="post-card-image-link" href="/2020/12/10/datadog-terraform/">
                <img class="post-card-image"src="/2020/12/10/datadog-terraform/images/Datadog-Monitor.png" alt="Datadog 알람을 Terraform으로 만들어 보자."/>
            </a>
        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="/2020/12/10/datadog-terraform/">
    
                <header class="post-card-header">
                    
                        
                        <div class="post-card-primary-tag">Post</div>
                    

                    <h2 class="post-card-title">Datadog 알람을 Terraform으로 만들어 보자.</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p>여러 클라우드 환경에서 이곳저곳 산재되어 있는 클라우드 리소스들을 통합적으로 모니터링이 가능하게 해주는 모니터링 솔루션인 Datadog을 알아 보자. Dat</p>
                </section>
    
            </a>

            
                
                
                <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"><b>황준하</b>님의 글 모두 보기</div>
                            <a href="/authors/junha-hwang/" class="static-avatar author-profile-image">
                            
                                <div class="author-profile"
                                    style="background: url(/authors/junha-hwang/%ed%99%a9%ec%a4%80%ed%95%98.jpg) no-repeat center; 
                                    background-size: cover; width: 30px; height: 30px; 
                                    border-radius: 100%; margin-bottom: 10px;">
                                </div>
                            
                            </a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span>황준하</span>
                        <span class="post-card-byline-date"><time datetime="2020-412-12">2020. 12. 10.</time>
                            <span class="bull">&bull;</span> 6 min read</span>
                    </div>
                </footer>
                
            
        </div>

</article>
        </div>
    </div>
</aside>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright">
                    <a href="/">
                    
                    © 2019-Present CLOUDMATE Corp
                    
                    </a>
                </section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    <a href="https://fb.me/cloudmatekr" target="_blank" rel="noopener">Facebook</a>
                    
                    <a href="https://github.com/mate365" target="_blank" rel="noopener">Github</a>
                    <a href="https://jonathanjanssens.com" target="_blank" rel="noopener" style="opacity: 0.5;">Hugo Casper3 by Jonathan Janssens</a>
                </nav>
            </div>
        </footer>

    </div>

</body>
</html>