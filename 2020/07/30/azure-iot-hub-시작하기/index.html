<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    
    
    <title>Azure IoT Hub 시작하기 -1 · CLOUDMATE Tech</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    
    <link rel="stylesheet" href="/style.main.min.9d230ec369c8d3684ed255cc9ec757b773e29a42722b21acce3bf658066bd2fc.css" />

    
    <link rel="stylesheet" href="/style.custom.min.1a1ac5f9352ddc8a966bca11adad9d9d1ec303128539f67fca1df56329b21436.css" />

</head>
<body class=" post-template ">

    <div class="site-wrapper">

<header class="site-header"><div class="outer site-nav-main">
    <div class="inner"><nav class="site-nav">
    <div class="site-nav-left">
        
            <a class="site-nav-logo" href="/">CLOUDMATE Tech</a>
        
        
        <div class="site-nav-content">
            <ul class="nav" role="menu">
                
                <li class="nav-home" role="menuitem"><a href="/categories/post">Post</a></li>
                
                
                <li class="nav-home" role="menuitem"><a href="https://cloudmt.co.kr">cloudmt.co.kr</a></li>
                
            </ul>
        </div>
        
    </div>
</nav></div>
</div></header>

<main id="site-main" class="site-main outer">
    <div class="inner">

        <article class="post-full post  no-image ">

            <header class="post-full-header">

                
                    
                    <section class="post-full-tags">
                        <a href="/categories/post">Post</a>
                    </section>
                

                <h1 class="post-full-title">Azure IoT Hub 시작하기 -1</h1>

                

                <div class="post-full-byline">
                    <section class="post-full-byline-content">

                        <ul class="author-list">
  <li class="author-list-item">
        <div class="author-card">
            <div class="author-profile-image"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><g fill="none" fill-rule="evenodd"><path d="M3.513 18.998C4.749 15.504 8.082 13 12 13s7.251 2.504 8.487 5.998C18.47 21.442 15.417 23 12 23s-6.47-1.558-8.487-4.002zM12 12c2.21 0 4-2.79 4-5s-1.79-4-4-4-4 1.79-4 4 1.79 5 4 5z" fill="#FFF"/></g></svg></div>
            <div class="author-info">
                <div class="author-info">
                    <h2>김예림</h2>
                </div>
            </div>
        </div>
        <a href="/authors/yerim-kim/" class="static-avatar author-profile-image">
            
                <div class="author-profile"
                    style="background: url(/authors/yerim-kim/%ea%b9%80%ec%98%88%eb%a6%bc.jpg) no-repeat center; 
                    background-size: cover; width: 30px; height: 30px; 
                    border-radius: 100%; margin-bottom: 10px;">
                </div>
            
        </a>
    </li>
  

</ul>

                        <section class="post-full-byline-meta">
                            
                                
                                <h4 class="author-name">김예림</h4>
                                
                            
                            <div class="byline-meta-content">
                                <time class="byline-meta-date" datetime="2020-127-07">2020. 07. 30.</time>
                                <span class="byline-reading-time"><span class="bull">&bull;</span> 3 min read</span>
                            </div>
                        </section>

                    </section>


                </div>
            </header>

            

            <section class="post-full-content">
                <div class="post-content">
                    <p>지난 포스팅에서 Azure에서 제안하는 IoT 아키텍처를 소개하고, 각 구성 요소를 살펴보았습니다.
이번에는 예제 애플리케이션을 사용하여 원격 장치 데이터를 IoT 허브로 전송하는 방법을 알아보겠습니다. 해당 예제의 시뮬레이터는 <strong>MQTT를 통해 IoT 허브로 온습도 정보를 1초에 한 번 전송</strong>하도록 구성되어 있습니다.</p>
<p>목차는 다음과 같습니다.</p>
<ul>
<li>실습 환경 설정</li>
<li>SDK 다운로드 및 빌드</li>
<li>IoT 허브 생성 및 디바이스 등록</li>
<li>허브에서 데이터 읽기</li>
<li>스토리지 계정으로 메시지 라우팅</li>
</ul>
<h2 id="1-실습-환경-설정">1. 실습 환경 설정</h2>
<ul>
<li>Visual Studio 2019 설치 - C++를 사용한 데스크톱 개발 워크로드 사용 설정</li>
<li>최신 버전의 Git 설치</li>
<li>애플리케이션을 실행할 환경의 방화벽에서 8883 포트를 열어 MQTT 프로토콜 통신 허용</li>
<li>운영 체제에 맞는 <a href="https://cmake.org/download/">CMake 빌드 시스템</a> 다운로드하고 환경 변수에 추가</li>
</ul>
<h2 id="2-sdk-다운로드-및-빌드">2. SDK 다운로드 및 빌드</h2>
<ol>
<li>Git Bash에서 다음 명령을 이용해 Azure IoT C SDK GitHub 리포지토리의 <a href="https://github.com/Azure/azure-iot-sdk-c/releases/tag/LTS_07_2020_Ref01">최신 버전</a>을 클론합니다. (작성일 기준 : LTS_07_2020_Ref01)</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">git clone -b LTS_07_2020_Ref01 https://github.com/Azure/azure-iot-sdk-c.git
cd azure-iot-sdk-c
git submodule update --init
</code></pre></div><ol start="2">
<li>Git 리포지토리 루트 디렉터리에 하위 디렉터리를 만들고 해당 폴더로 이동하여 SDK 버전을 빌드합니다.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">mkdir cmake
cd cmake
cmake ..
</code></pre></div><h2 id="3-iot-hub-생성-및-디바이스-등록">3. IoT Hub 생성 및 디바이스 등록</h2>
<h3 id="iot-hub-생성">IoT Hub 생성</h3>
<ol>
<li>Azure 포털에서 <strong>IoT 허브</strong>를 검색하여 <strong>만들기</strong>를 선택합니다. 지금은 테스트용으로 제공되는 Free Version을 사용해도 됩니다. 서비스를 운용하기 위한 계층은 다음 링크를 참고하여 선택합니다.</li>
</ol>
<blockquote>
<p><a href="https://docs.microsoft.com/ko-kr/azure/iot-hub/iot-hub-scaling">IoT 허브 계층 선택</a> - 디바이스 관리를 위한 IoT Edge를 사용하거나, 디바이스와 IoT 허브 양방향 통신 기능이 필요한 경우라면 표준 계층(S1~S3)을 선택해야 합니다.</p>
</blockquote>
<ol start="2">
<li>Cloud Shell 창의 Bash 셸에서 다음 명령을 실행하여 IoT 디바이스 ID를 생성합니다.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">az extension add --name azure-iot <span style="color:#75715e">#Azure IoT 확장 사용</span>
az iot hub device-identity create --hub-name &lt;Your IoT Hub name&gt; --device-id MyCDevice <span style="color:#75715e">#MyCDevice라는 디바이스 ID 생성</span>
</code></pre></div><ol start="3">
<li>생성된 IoT 디바이스의 연결 문자열을 확인합니다.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">az iot hub device-identity show-connection-string --hub-name &lt;Your IoT Hub name&gt; --device-id MyCDevice --output table
</code></pre></div><h3 id="디바이스-등록">디바이스 등록</h3>
<ol>
<li>Git Bash에서 아래 경로의 소스 파일을 열어 샘플 코드를 수정합니다.</li>
</ol>
<blockquote>
<p><em>azure-iot-sdk-c\iothub_client\samples\iothub_convenience_sample\iothub_convenience_sample.c</em></p>
</blockquote>
<ol start="2">
<li>
<p>static const char* connectionString = &ldquo;[device connection string]&quot;; 부분을 찾아 연결 문자열로 대체합니다.</p>
</li>
<li>
<p>CMake 디렉터리의 iothub_convenience_sample 프로젝트 디렉터리로 이동합니다.</p>
</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cd azure-iot-sdk-c/cmake/iothub_client/samples/iothub_convenience_sample
</code></pre></div><ol start="4">
<li>시뮬레이션된 디바이스 애플리케이션을 빌드합니다.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cmake --build . --target iothub_convenience_sample --config Debug
</code></pre></div><ol start="5">
<li>빌드 결과물을 실행합니다.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Debug/iothub_convenience_sample.exe
</code></pre></div><p><img src="images/result.png" alt="온습도 정보를 계속 보내는 중"></p>
<h2 id="4-허브에서-데이터-읽기">4. 허브에서 데이터 읽기</h2>
<ol>
<li>Cloud Shell 창의 Bash 셸에서 다음 명령을 실행하여 IoT 허브 메시지를 연결하여 읽어옵니다.</li>
</ol>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">az iot hub monitor-events --hub-name &lt;Your IoT Hub name&gt; --output table
</code></pre></div><p><img src="images/hubmsg.png" alt="허브에서 메시지 확인"></p>
<h2 id="5-스토리지-계정으로-메시지-라우팅">5. 스토리지 계정으로 메시지 라우팅</h2>
<p>IoT Hub에는 메시지 라우팅 기능이 있습니다. 사용자 지정 엔드포인트로 Azure Storage Container, Event Hub, Service Bus Queue 및 Topic을 지원합니다. 쿼리 기반으로 메시지를 라우팅할 수 있고, 쿼리에 맞는 엔드포인트가 없으면 Event Hub와 호환되는 기본 제공 엔드포인트로 메시지를 보냅니다. 이 기능을 사용하면 여러 IoT 장치에서 오는 메시지를 나눠서 저장할 수 있습니다. 또한, 메시지를 여러 엔드포인트에 전송하여 분석이나 알람 등 추가 작업을 수행할 수 있습니다.</p>
<p>해당 예제에서는 <strong>스토리지 계정의 컨테이너</strong>를 엔드포인트로 지정합니다.</p>
<ol>
<li>
<p>스토리지 계정에 메시지를 저장할 컨테이너를 생성합니다.</p>
</li>
<li>
<p>IoT Hub 메뉴에서 메시지 라우팅을 선택하여 <strong>추가</strong>를 클릭합니다.</p>
</li>
<li>
<p>엔드포인트 선택 창 옆의 +추가를 클릭하고, 유형을 스토리지로 선택합니다.</p>
</li>
<li>
<p>앞서 생성한 컨테이너를 지정하고 인코딩 형식을 지정합니다. (AVRO와 JSON 지원)</p>
</li>
<li>
<p>라우팅 쿼리 기본 값은 true로 설정되어 있습니다. 이를 그대로 사용하면 허브로 오는 모든 메시지를 스토리지 계정으로 라우팅합니다.</p>
</li>
</ol>
<p><img src="images/route.png" alt="라우팅 설정"></p>
<blockquote>
<p>$connectionDeviceID = &lsquo;MyCDevice&rsquo; 처럼 지정하면 특정 IoT 장치(MyCDevice)에서 들어오는 메시지만 저장할 수 있습니다.
<a href="https://docs.microsoft.com/ko-kr/azure/iot-hub/iot-hub-devguide-routing-query-syntax">쿼리문 참고 문서</a></p>
</blockquote>
<ol start="6">
<li>애플리케이션 실행 후 결과를 확인합니다.</li>
</ol>
<p><img src="images/result2.png" alt="스토리지 계정 저장 결과 확인"></p>
<blockquote>
<p><strong>참고</strong> : 테스트 결과, 애플리케이션 실행 결과를 스토리지 계정에 저장하는 작업은 1분 미만 소요됩니다.</p>
</blockquote>
<p>지금까지 온습도 정보를 보내는 시뮬레이터를 생성하여 IoT 허브와 연결하고, 스토리지 계정에 라우팅하는 방법을 알아보았습니다.</p>
<p>다음 포스팅에서는 Azure Stream Analytics job에 원격 장치 데이터를 전송하는 방법을 소개하겠습니다.</p>

                </div>
            </section>

        </article>

    </div>
</main>
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">

    <article class="read-next-card">
        <header class="read-next-card-header">
            <h3><span>More in</span> <a href="/categories/post">Post</a></h3>
        </header>
        <div class="read-next-card-content">
            <ul>
                
                <li>
                    <h4><a href="/2021/02/17/spot_by_netapp_%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/">Spot By NetApp 시작하기</a></h4>
                    <div class="read-next-card-meta">
                            <p><time datetime="2021-122-02">2021. 02. 17.</time> 
                                
                            </p>
                    </div>
                </li>
                
                <li>
                    <h4><a href="/2021/02/16/devtest-%ED%86%B5%ED%95%9C-devops-%EA%B5%AC%EC%84%B1%ED%95%98%EA%B8%B0/">DevTest 통한 DevOps 구성하기</a></h4>
                    <div class="read-next-card-meta">
                            <p><time datetime="2021-122-02">2021. 02. 16.</time> 
                                
                            </p>
                    </div>
                </li>
                
                <li>
                    <h4><a href="/2021/02/16/%EC%A0%81%EC%A0%88%ED%95%9Cazure%EC%9A%B4%EC%98%81%EC%9C%BC%EB%A1%9C%EB%B9%84%EC%9A%A9%EC%9D%84%EC%B5%9C%EC%A0%81%ED%99%94%ED%95%98%EC%8B%9C%EB%A9%B4%EB%90%A9%EB%8B%88%EB%8B%A4/">적절한 Azure 운영으로 비용을 최적화하시면 됩니다.</a></h4>
                    <div class="read-next-card-meta">
                            <p><time datetime="2021-122-02">2021. 02. 16.</time> 
                                
                            </p>
                    </div>
                </li>
                
            </ul>
        </div>
    </article>
<article class="post-card post
 no-image
 ">

        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="/2020/07/27/azure-iot-architecture/">
    
                <header class="post-card-header">
                    
                        
                        <div class="post-card-primary-tag">Post</div>
                    

                    <h2 class="post-card-title">Azure IoT Architecture</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p>IoT란 각종 사물에 센서와 통신 기능을 내장하여 무선 네트워크 상에서 데이터를 수집하고 전송하는 시스템을 말합니다. Azure Architecture Center에서 제안하는 IoT 참조 아키</p>
                </section>
    
            </a>

            
                
                
                <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"><b>김예림</b>님의 글 모두 보기</div>
                            <a href="/authors/yerim-kim/" class="static-avatar author-profile-image">
                            
                                <div class="author-profile"
                                    style="background: url(/authors/yerim-kim/%ea%b9%80%ec%98%88%eb%a6%bc.jpg) no-repeat center; 
                                    background-size: cover; width: 30px; height: 30px; 
                                    border-radius: 100%; margin-bottom: 10px;">
                                </div>
                            
                            </a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span>김예림</span>
                        <span class="post-card-byline-date"><time datetime="2020-127-07">2020. 07. 27.</time>
                            <span class="bull">&bull;</span> 6 min read</span>
                    </div>
                </footer>
                
            
        </div>

</article>

            <article class="post-card post
 no-image
 ">

        
    
        <div class="post-card-content">
    
            <a class="post-card-content-link" href="/2020/07/31/azure-iot-hub-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0-3/">
    
                <header class="post-card-header">
                    
                        
                        <div class="post-card-primary-tag">Post</div>
                    

                    <h2 class="post-card-title">Azure IoT Hub 시작하기 -3</h2>
                </header>
    
                <section class="post-card-excerpt">
                    <p>IoT Hub에서 서비스 버스로 라우팅을 설정하고, Logic Apps를 이용해 메일 알람을 설정하는 방법을 알아보겠습니다. 장비의 이상 탐지를 위해 IoT Hub에서 특정 값이</p>
                </section>
    
            </a>

            
                
                
                <footer class="post-card-meta">
                    <ul class="author-list">
                        <li class="author-list-item">
                            <div class="author-name-tooltip"><b>김예림</b>님의 글 모두 보기</div>
                            <a href="/authors/yerim-kim/" class="static-avatar author-profile-image">
                            
                                <div class="author-profile"
                                    style="background: url(/authors/yerim-kim/%ea%b9%80%ec%98%88%eb%a6%bc.jpg) no-repeat center; 
                                    background-size: cover; width: 30px; height: 30px; 
                                    border-radius: 100%; margin-bottom: 10px;">
                                </div>
                            
                            </a>
                        </li>
                    </ul>
                    <div class="post-card-byline-content">
                        <span>김예림</span>
                        <span class="post-card-byline-date"><time datetime="2020-127-07">2020. 07. 31.</time>
                            <span class="bull">&bull;</span> 3 min read</span>
                    </div>
                </footer>
                
            
        </div>

</article>
        </div>
    </div>
</aside>


        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="/">CLOUDMATE Tech</a> &copy; 2020</section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    <a href="https://fb.me/cloudmatekr" target="_blank" rel="noopener">Facebook</a>
                    
                    <a href="https://github.com/mate365" target="_blank" rel="noopener">Github</a>
                    <a href="https://jonathanjanssens.com" target="_blank" rel="noopener" style="opacity: 0.5;">Hugo Casper3 by Jonathan Janssens</a>
                </nav>
            </div>
        </footer>

    </div>

</body>
</html>